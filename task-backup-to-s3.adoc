---
sidebar: sidebar 
permalink: task-backup-to-s3.html 
keywords: backing up, back up, backup, backup cloud volumes ontap, back up cloud volumes ontap, cloud volumes ontap, aws, aws s3, amazon s3, s3 bucket, back up volumes, cloud backup 
summary: 完成以下几个步骤、开始将卷数据从Cloud Volumes ONTAP 系统备份到Amazon S3。 
---
= 将 Cloud Volumes ONTAP 数据备份到 Amazon S3
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
完成以下几个步骤、开始将卷数据从Cloud Volumes ONTAP 系统备份到Amazon S3。



== 快速入门

按照以下步骤快速入门，或者向下滚动到其余部分以了解完整详细信息。

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png["一个"] 验证是否支持您的配置
[role="quick-margin-list"]
* 您正在AWS中运行Cloud Volumes ONTAP 9.7P5或更高版本(建议使用ONTAP 9.8P13及更高版本)。
* 您已为备份所在的存储空间订阅了有效的云提供商。
* 您已订阅 https://["BlueXP Marketplace备份服务"]，和 https://["AWS 年度合同"]或您已购买 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["并激活"] NetApp提供的BlueXP备份和恢复BYOL许可证。
* 您已在AWS中安装Connector：
+
** 连接器可以安装在具有完全互联网访问("标准模式")或有限互联网连接("受限模式")的站点上。
** 为BlueXP Connector提供权限的IAM角色包括最新版本的S3权限 https://["BlueXP策略"^]。




.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png["两个"] 在新系统或现有系统上启用BlueXP备份和恢复
[role="quick-margin-list"]
* 新系统：默认情况下、在工作环境向导中启用BlueXP备份和恢复。请务必保持此选项处于启用状态。
* 现有系统：选择工作环境、然后单击右侧面板中备份和恢复服务旁边的*启用*、然后按照设置向导进行操作。
+
image:screenshot_backup_cvo_enable.png["屏幕截图显示了\"启用备份和恢复\"按钮、该按钮可在您选择工作环境后使用。"]



.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png["三个"] 输入提供程序详细信息
[role="quick-margin-para"]
选择 AWS 帐户以及要创建备份的区域。您还可以选择自己的客户管理密钥进行数据加密，而不是使用默认的 Amazon S3 加密密钥。

[role="quick-margin-para"]
image:screenshot_backup_provider_settings_aws.png["显示将卷从 Cloud Volumes ONTAP 系统备份到 AWS S3 时云提供商详细信息的屏幕截图。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-4.png["四个"] 定义默认备份策略
[role="quick-margin-para"]
默认策略每天备份卷，并保留每个卷的最新 30 个备份副本。更改为每小时、每天、每周、每月或每年备份、 或者、选择一个系统定义的策略以提供更多选项。您还可以更改要保留的备份副本数。

[role="quick-margin-para"]
默认情况下，备份存储在 S3 标准存储中。如果集群使用的是 ONTAP 9.10.1 或更高版本，则可以选择在一定天数后将备份分层到 S3 Glacier 或 S3 Glacier 深度归档存储，以进一步优化成本。

[role="quick-margin-para"]
或者、在使用ONTAP 9.11.1及更高版本时、您也可以选择通过配置_DataLock和勒索软件保护_设置之一来保护备份免受删除和勒索软件攻击。 link:concept-cloud-backup-policies.html["详细了解可用的BlueXP备份和恢复策略配置设置"^]。

[role="quick-margin-para"]
image:screenshot_backup_policy_aws.png["屏幕截图显示了BlueXP备份和恢复设置、您可以在其中选择备份计划和保留期限。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-5.png["五个"] 选择要备份的卷
[role="quick-margin-para"]
在选择卷页面中，使用默认备份策略确定要备份的卷。如果要为某些卷分配不同的备份策略，可以创建其他策略并稍后将其应用于卷。



== 要求

开始将卷备份到 S3 之前，请阅读以下要求，以确保您的配置受支持。

下图显示了每个组件以及需要在它们之间准备的连接：

image:diagram_cloud_backup_cvo_aws.png["一个示意图、显示了BlueXP备份和恢复如何与备份文件所在的源系统和目标存储上的卷进行通信。"]

VPC网关端点必须已存在于VPC中。 https://["详细了解网关端点"^]。

支持的 ONTAP 版本:: 建议至少使用ONTAP 9.7P5；ONTAP 9.8P13及更高版本。
许可证要求:: 对于BlueXP备份和恢复PAYGO许可、AWS Marketplace中提供了一个BlueXP订阅、用于部署Cloud Volumes ONTAP 和BlueXP备份和恢复。您需要 https://["订阅此BlueXP订阅"^] 在启用BlueXP备份和恢复之前。BlueXP备份和恢复的计费通过此订阅完成。
+
--
对于能够同时备份 Cloud Volumes ONTAP 数据和内部 ONTAP 数据的年度合同，您需要从订阅 https://["AWS Marketplace 页面"^] 然后 https://["将订阅与您的 AWS 凭据关联"^]。

对于能够捆绑Cloud Volumes ONTAP 和BlueXP备份和恢复的年度合同、您必须在创建Cloud Volumes ONTAP 工作环境时设置年度合同。此选项不允许您备份内部数据。

对于BlueXP备份和恢复BYOL许可、您需要NetApp提供的序列号、以便在许可证有效期和容量内使用此服务。 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["了解如何管理 BYOL 许可证"]。如果连接器和Cloud Volumes ONTAP 系统部署在非公开站点中、则必须使用BYOL许可证。

您需要为备份所在的存储空间创建一个 AWS 帐户。

--
使用客户管理的密钥进行数据加密所需的信息:: 您可以在激活向导中选择自己的客户管理的数据加密密钥，而不是使用默认的 Amazon S3 加密密钥。在这种情况下，您需要已设置加密受管密钥。 https://["了解如何使用您自己的密钥"^]。
连接器要求:: Connector可以安装在具有完全或有限Internet访问权限("标准"或"受限"模式)的AWS地区。 https://["有关详细信息、请参见BlueXP部署模式"^]。
+
--
* https://["了解连接器"^]
* https://["在标准模式下在AWS中部署Connector (完全Internet访问)"^]
* https://["在受限模式下安装连接器(受限出站访问)"^]


--
所需的AWS Connector权限:: 为BlueXP提供权限的IAM角色必须包括最新版本的S3权限 https://["BlueXP策略"^]。如果此策略不包含所有这些权限、请参见 https://["AWS 文档：编辑 IAM 策略"]。
+
--
以下是策略中的特定权限：

[source, json]
----
{
            "Sid": "backupPolicy",
            "Effect": "Allow",
            "Action": [
                "s3:DeleteBucket",
                "s3:GetLifecycleConfiguration",
                "s3:PutLifecycleConfiguration",
                "s3:PutBucketTagging",
                "s3:ListBucketVersions",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:PutObject",
                "s3:ListBucket",
                "s3:ListAllMyBuckets",
                "s3:GetBucketTagging",
                "s3:GetBucketLocation",
                "s3:GetBucketPolicyStatus",
                "s3:GetBucketPublicAccessBlock",
                "s3:GetBucketAcl",
                "s3:GetBucketPolicy",
                "s3:PutBucketPolicy",
                "s3:PutBucketOwnershipControls"
                "s3:PutBucketPublicAccessBlock",
                "s3:PutEncryptionConfiguration",
                "s3:GetObjectVersionTagging",
                "s3:GetBucketObjectLockConfiguration",
                "s3:GetObjectVersionAcl",
                "s3:PutObjectTagging",
                "s3:DeleteObjectTagging",
                "s3:GetObjectRetention",
                "s3:DeleteObjectVersionTagging",
                "s3:PutBucketObjectLockConfiguration",
                "s3:ListBucketByTags",
                "s3:DeleteObjectVersion",
                "s3:GetObjectTagging",
                "s3:PutBucketVersioning",
                "s3:PutObjectVersionTagging",
                "s3:GetBucketVersioning",
                "s3:BypassGovernanceRetention",
                "s3:PutObjectRetention",
                "s3:GetObjectVersion",
                "athena:StartQueryExecution",
                "athena:GetQueryResults",
                "athena:GetQueryExecution",
                "glue:GetDatabase",
                "glue:GetTable",
                "glue:CreateTable",
                "glue:CreateDatabase",
                "glue:GetPartitions",
                "glue:BatchCreatePartition",
                "glue:BatchDeletePartition"
            ],
            "Resource": [
                "arn:aws:s3:::netapp-backup-*"
            ]
        },
----
--



NOTE: 在AWS中国地区创建备份时、您需要将IAM策略中所有_Resource_部分下的AWS资源名称"arn"从"aws"更改为"AAWS CN"；例如 `arn:aws-cn:s3:::netapp-backup-*`。

所需的AWS Cloud Volumes ONTAP 权限:: 如果您的Cloud Volumes ONTAP 系统运行的是ONTAP 9.12.1或更高版本的软件、则为该工作环境提供权限的IAM角色必须包括一组新的S3权限、专门用于从最新版本进行的BlueXP备份和恢复 https://["Cloud Volumes ONTAP 策略"^]。
+
--
如果您使用BlueXP 3.9.23或更高版本创建了Cloud Volumes ONTAP 工作环境、则这些权限应已属于IAM角色。否则，您需要添加缺少的权限。

--
支持的 AWS 区域:: 所有AWS地区均支持BlueXP备份和恢复 https://["支持 Cloud Volumes ONTAP 的位置"^]；包括 AWS GovCloud 地区。
在其他 AWS 帐户中创建备份所需的设置:: 默认情况下，备份是使用与 Cloud Volumes ONTAP 系统相同的帐户创建的。如果要使用其他AWS帐户进行备份、则必须：
+
--
* 验证权限"S3：PutBucketPolicy"和"S3：PutBucketOwnershipControls"是否属于为BlueXP Connector提供权限的IAM角色。
* 在BlueXP中添加目标AWS帐户凭据。 https://["了解如何执行此操作"^]。
* 在第二个帐户的用户凭据中添加以下权限：
+
....
"athena:StartQueryExecution",
"athena:GetQueryResults",
"athena:GetQueryExecution",
"glue:GetDatabase",
"glue:GetTable",
"glue:CreateTable",
"glue:CreateDatabase",
"glue:GetPartitions",
"glue:BatchCreatePartition",
"glue:BatchDeletePartition"
....


--




== 在新系统上启用BlueXP备份和恢复

默认情况下、在工作环境向导中会启用BlueXP备份和恢复。请务必保持此选项处于启用状态。

请参见 https://["在 AWS 中启动 Cloud Volumes ONTAP"^] 有关创建 Cloud Volumes ONTAP 系统的要求和详细信息，请参见。

.步骤
. 单击 * 创建 Cloud Volumes ONTAP * 。
. 选择 Amazon Web Services 作为云提供商，然后选择单个节点或 HA 系统。
. 填写详细信息和凭据页面。
. 在服务页面上，保持服务处于启用状态，然后单击 * 继续 * 。
+
image:screenshot_backup_to_gcp.png["显示了工作环境向导中的BlueXP备份和恢复选项。"]

. 完成向导中的页面以部署系统。


.结果
在系统上启用了BlueXP备份和恢复功能、每天备份卷并保留最近30个备份副本。



== 在现有系统上启用BlueXP备份和恢复

随时直接从工作环境启用BlueXP备份和恢复。

.步骤
. 选择工作环境、然后单击右面板中备份和恢复服务旁边的*启用*。
+
如果您的备份的Amazon S3目标作为工作环境存在于Canvas上、您可以将集群拖动到Amazon S3工作环境中以启动设置向导。

+
image:screenshot_backup_cvo_enable.png["屏幕截图显示了\"启用备份和恢复\"按钮、该按钮可在您选择工作环境后使用。"]

. 选择提供程序详细信息并单击 * 下一步 * ：
+
.. 用于存储备份的 AWS 帐户。此帐户可以与 Cloud Volumes ONTAP 系统所驻留的帐户不同。
+
如果要使用其他AWS帐户进行备份、则必须在BlueXP中添加目标AWS帐户凭据、并将权限"S3：PutBucketPolicy"和"S3：PutBucketOwnershipControls"添加到为BlueXP提供权限的IAM角色中。

.. 要存储备份的区域。此区域可以与 Cloud Volumes ONTAP 系统所在的区域不同。
.. 是使用默认 Amazon S3 加密密钥，还是从 AWS 帐户中选择您自己的客户管理密钥来管理数据加密。 (https://["了解如何使用您自己的加密密钥"]）。
+
image:screenshot_backup_provider_settings_aws.png["显示将卷从 Cloud Volumes ONTAP 系统备份到 AWS S3 时云提供商详细信息的屏幕截图。"]



. 输入要用于默认策略的备份策略详细信息、然后单击*下一步*。您可以选择现有策略、也可以通过在每个部分中输入所做的选择来创建新策略：
+
.. 输入默认策略的名称。您无需更改名称。
.. 定义备份计划并选择要保留的备份数。 link:concept-ontap-backup-to-cloud.html#customizable-backup-schedule-and-retention-settings["请参见您可以选择的现有策略列表"^]。
.. 或者、在使用ONTAP 9.11.1及更高版本时、您也可以选择通过配置_DataLock和勒索软件保护_设置之一来保护备份免受删除和勒索软件攻击。_DataLock_可防止您的备份文件被修改或删除、_勒索 软件保护_会扫描您的备份文件、以在备份文件中查找勒索软件攻击的证据。 link:concept-cloud-backup-policies.html#datalock-and-ransomware-protection["详细了解可用的DataLock设置"^]。
.. 或者、在使用ONTAP 9.10.1及更高版本时、您也可以选择在一定天数后将备份分层到S3 Glacier或S3 Glacier深度归档存储、以进一步优化成本。在非公开站点中部署时、此功能不可用。 link:reference-aws-backup-tiers.html["了解有关使用归档层的更多信息"]。
+
image:screenshot_backup_policy_aws.png["屏幕截图显示了BlueXP备份和恢复设置、您可以在其中选择计划和备份保留。"]

+
*重要信息：*如果您计划使用DataLock、则必须在激活BlueXP备份和恢复时在第一个策略中启用它。



. 在选择卷页面中、使用定义的备份策略选择要备份的卷。如果要为某些卷分配不同的备份策略，可以创建其他策略并稍后将其应用于这些卷。
+
** 要备份所有现有卷以及将来添加的任何卷、请选中"备份所有现有卷和未来卷..."框。我们建议使用此选项、以便备份所有卷、您不必记住为新卷启用备份。
** 要仅备份现有卷、请选中标题行(image:button_backup_all_volumes.png[""]）。
** 要备份单个卷，请选中每个卷对应的框（image:button_backup_1_volume.png[""]）。
+
image:screenshot_backup_select_volumes.png["选择要备份的卷的屏幕截图。"]

** 如果此工作环境中的读/写卷有任何本地Snapshot副本与您刚刚为此工作环境选择的备份计划标签(例如、每日、每周等)匹配、则会显示一条额外的提示"将现有Snapshot副本作为备份副本导出到对象存储"。如果要将所有历史快照作为备份文件复制到对象存储、请选中此框、以确保为卷提供最全面的保护。


. 单击*激活备份*、BlueXP备份和恢复将开始对每个选定卷进行初始备份。


.结果
系统会在您输入的 S3 访问密钥和机密密钥所指示的服务帐户中自动创建 S3 存储分段，备份文件存储在该处。此时将显示卷备份信息板，以便您可以监控备份的状态。您还可以使用监控备份和还原作业的状态 link:task-monitor-backup-jobs.html["作业监控面板"^]。



== 下一步是什么？

* 您可以 link:task-manage-backups-ontap.html["管理备份文件和备份策略"^]。其中包括启动和停止备份、删除备份、添加和更改备份计划等。
* 您可以 link:task-manage-backup-settings-ontap.html["管理集群级别的备份设置"^]。其中包括更改ONTAP 用于访问云存储的存储密钥、更改可用于将备份上传到对象存储的网络带宽、更改未来卷的自动备份设置等。
* 您也可以 link:task-restore-backups-ontap.html["从备份文件还原卷、文件夹或单个文件"^] 连接到 AWS 中的 Cloud Volumes ONTAP 系统或内部 ONTAP 系统。

