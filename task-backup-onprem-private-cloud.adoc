---
sidebar: sidebar 
permalink: task-backup-onprem-private-cloud.html 
keywords: backing up, back up, backup, backup on-prem ontap, on-prem, on-premises, back up volumes, cloud backup, StorageGRID 
summary: 完成几个步骤、开始将卷数据从内部ONTAP 系统备份到NetApp StorageGRID 系统中的对象存储。 
---
= 将内部 ONTAP 数据备份到 StorageGRID
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
完成几个步骤、开始将卷数据从内部ONTAP 系统备份到NetApp StorageGRID 系统中的对象存储。

请注意， " 内部 ONTAP 系统 " 包括 FAS ， AFF 和 ONTAP Select 系统。



== 快速入门

按照以下步骤快速入门，或者向下滚动到其余部分以了解完整详细信息。

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png["一个"] 验证是否支持您的配置
[role="quick-margin-list"]
* 您已发现内部集群并将其添加到BlueXP中的工作环境中。请参见 https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["发现 ONTAP 集群"^] 了解详细信息。
+
** 此集群运行的是 ONTAP 9.7P5 或更高版本。
** 集群具有 SnapMirror 许可证—它作为超值包或数据保护包的一部分提供。
** 集群必须与 StorageGRID 和 Connector 建立所需的网络连接。


* 您的内部安装了一个 Connector 。
+
** 无论是否可访问 Internet ，均可将 Connector 安装在站点中。
** 通过为连接器建立网络，可以与 ONTAP 集群和 StorageGRID 建立出站 HTTPS 连接。


* 您已购买 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["并激活"^] NetApp提供的BlueXP备份和恢复BYOL许可证。
* 您的 StorageGRID 安装了 10.3 或更高版本，并且访问密钥具有 S3 权限。


.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png["两个"] 在系统上启用BlueXP备份和恢复
[role="quick-margin-para"]
选择源ONTAP 工作环境、然后单击右侧面板中备份和恢复服务旁边的*启用>备份卷*、然后按照设置向导进行操作。

[role="quick-margin-para"]
image:screenshot_backup_onprem_enable.png["屏幕截图显示了\"启用备份和恢复\"按钮、该按钮可在您选择工作环境后使用。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png["三个"] 输入 StorageGRID 详细信息
[role="quick-margin-para"]
选择StorageGRID 作为提供程序、然后输入StorageGRID 服务器和S3租户帐户详细信息。您还需要在卷所在的 ONTAP 集群中指定 IP 空间。

[role="quick-margin-para"]
image:screenshot_backup_provider_settings_storagegrid.png["显示将卷从 ONTAP 集群备份到 StorageGRID 时云提供商详细信息的屏幕截图。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-4.png["四个"] 定义默认备份策略
[role="quick-margin-para"]
默认策略每天备份卷，并保留每个卷的最新 30 个备份副本。更改为每小时、每天、每周、每月或每年备份、 或者、选择一个系统定义的策略以提供更多选项。您还可以更改要保留的备份副本数。

[role="quick-margin-para"]
如果集群使用的是ONTAP 9.12.1或更高版本、而StorageGRID 系统使用的是11.4或更高版本、则可以选择在一定天数后将旧备份分层到公共云归档层、以进一步优化成本。目前支持AWS S3 Glacer/S3 Glacier深度归档或Azure归档存储层。

[role="quick-margin-para"]
如果您的集群使用的是ONTAP 9.11.1或更高版本、则可以选择通过配置_DataLock和勒索软件保护_设置之一来保护您的备份免受删除和勒索软件攻击。 link:concept-cloud-backup-policies.html["详细了解可用的BlueXP备份和恢复策略配置设置"^]。

[role="quick-margin-para"]
image:screenshot_backup_onprem_policy.png["屏幕截图显示了BlueXP备份和恢复设置、您可以在其中选择备份计划和保留期限。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-5.png["五个"] 选择要备份的卷
[role="quick-margin-para"]
在选择卷页面中，使用默认备份策略确定要备份的卷。如果要为某些卷分配不同的备份策略，可以创建其他策略并稍后将其应用于卷。

[role="quick-margin-para"]
在StorageGRID 上、系统会自动在您输入的S3访问密钥和机密密钥所指示的服务帐户中创建S3存储分段、并且备份文件会存储在该处。



== 要求

在开始将内部卷备份到 StorageGRID 之前，请阅读以下要求，以确保您的配置受支持。

下图显示了将内部ONTAP 系统备份到StorageGRID 时的每个组件以及需要在它们之间准备的连接。

image:diagram_cloud_backup_onprem_storagegrid.png["一个示意图、显示了BlueXP备份和恢复如何与备份文件所在的源系统和目标存储上的卷进行通信。"]

如果将连接器和内部ONTAP 系统安装在无法访问Internet的内部位置("非公开站点")、则StorageGRID 系统必须位于同一内部数据中心。在非公开站点配置中、不支持将旧备份文件归档到公共云。



=== 准备 ONTAP 集群

您需要先在BlueXP中发现内部ONTAP 集群、然后才能开始备份卷数据。

https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["了解如何发现集群"^]。

ONTAP 要求::
+
--
* 建议至少使用ONTAP 9.7P5；ONTAP 9.8P13及更高版本。
* SnapMirror 许可证（作为超值包或数据保护包的一部分提供）。
+
*注意：*使用BlueXP备份和恢复时、不需要"混合云捆绑包"。

+
请参见操作说明 https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html["管理集群许可证"^]。

* 已正确设置时间和时区。
+
请参见操作说明 https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html["配置集群时间"^]。



--
集群网络连接要求::
+
--
* ONTAP 集群通过用户指定的端口从集群间LIF启动HTTPS连接到StorageGRID 网关节点、以执行备份和还原操作。此端口可在备份设置期间进行配置。
+
ONTAP 可在对象存储之间读取和写入数据。对象存储永远不会启动，而只是响应。

* ONTAP 需要从连接器到集群管理 LIF 的入站连接。连接器必须位于您的内部。
* 托管要备份的卷的每个 ONTAP 节点都需要一个集群间 LIF 。LIF 必须与 _IP 空间 _ 关联， ONTAP 应使用此 _IP 空间 _ 连接到对象存储。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["了解有关 IP 空间的更多信息"^]。
+
设置BlueXP备份和恢复时、系统会提示您使用IP空间。您应选择与每个 LIF 关联的 IP 空间。这可能是您创建的 " 默认 "IP 空间或自定义 IP 空间。

* 节点的集群间 LIF 可以访问对象存储（如果在 " 非公开 " 站点中安装了 Connector ，则不需要）。
* 已为卷所在的 Storage VM 配置 DNS 服务器。请参见操作说明 https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html["为 SVM 配置 DNS 服务"^]。
* 请注意，如果您使用的 IP 空间与默认 IP 空间不同，则可能需要创建静态路由才能访问对象存储。
* 如有必要、请更新防火墙规则、以允许通过您指定的端口(通常为端口443)从ONTAP 到对象存储的BlueXP备份和恢复服务连接、并允许通过端口53 (TCP/UDP)从Storage VM到DNS服务器的名称解析流量。


--




=== 正在准备 StorageGRID

StorageGRID 必须满足以下要求。请参见 https://docs.netapp.com/us-en/storagegrid-116/["StorageGRID 文档"^] 有关详细信息 ...

支持的 StorageGRID 版本:: 支持 StorageGRID 10.3 及更高版本。
+
--
要对备份使用DataLock &勒索软件保护、您的StorageGRID 系统必须运行11.6.0.3或更高版本。

要将较早的备份分层到云归档存储、您的StorageGRID 系统必须运行11.3或更高版本。

--
S3 凭据:: 您必须已创建S3租户帐户来控制对StorageGRID 存储的访问。 https://docs.netapp.com/us-en/storagegrid-116/admin/creating-tenant-account.html["有关详细信息、请参见StorageGRID 文档"^]。
+
--
在设置到StorageGRID 的备份时、备份向导会提示您为租户帐户提供S3访问密钥和机密密钥。通过租户帐户、BlueXP备份和恢复功能可以对用于存储备份的StorageGRID 存储分段进行身份验证和访问。这些密钥是必需的，以便 StorageGRID 知道是谁发出请求。

这些访问密钥必须与具有以下权限的用户相关联：

[source, json]
----
"s3:ListAllMyBuckets",
"s3:ListBucket",
"s3:GetObject",
"s3:PutObject",
"s3:DeleteObject",
"s3:CreateBucket"
----
--
对象版本控制:: 不能在对象存储分段上手动启用StorageGRID 对象版本控制。




=== 创建或切换连接器

将数据备份到 StorageGRID 时，您的内部必须具有一个连接器。您需要安装新的 Connector 或确保当前选定的 Connector 位于内部。无论是否可访问 Internet ，均可将 Connector 安装在站点中。

* https://docs.netapp.com/us-en/cloud-manager-setup-admin/concept-connectors.html["了解连接器"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-quick-start-connector-on-prem.html["在可访问 Internet 的 Linux 主机上安装 Connector"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-quick-start-private-mode.html["在无法访问 Internet 的 Linux 主机上安装 Connector"^]



NOTE: BlueXP备份和恢复功能内置在BlueXP Connector中。如果安装在无法连接 Internet 的站点上，则需要定期更新 Connector 软件才能访问新功能。检查 link:whats-new.html["BlueXP备份和恢复新增功能"] 要查看每个BlueXP备份和恢复版本中的新功能、然后您可以按照中的步骤进行操作 https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-managing-connectors.html#upgrade-the-connector-when-using-private-mode["升级 Connector 软件"^] 希望使用新功能时。

强烈建议您在没有Internet连接的站点上安装Connector时、定期为BlueXP备份和恢复配置数据创建本地备份。 link:reference-backup-cbs-db-in-dark-site.html["了解如何在非公开站点中备份BlueXP备份和恢复数据"^]。



=== 为连接器准备网络连接

确保此连接器具有所需的网络连接。

.步骤
. 确保安装 Connector 的网络启用以下连接：
+
** 通过端口443与StorageGRID 网关节点建立HTTPS连接
** 通过端口 443 与 ONTAP 集群管理 LIF 建立 HTTPS 连接
** 通过端口443到BlueXP备份和恢复的出站Internet连接(在"非公开"站点中安装Connector时不需要)






=== 准备将旧备份文件归档到公共云存储

将较旧的备份文件分层到归档存储可为您可能不需要的备份使用成本较低的存储类、从而节省资金。StorageGRID 是一种内部(私有云)解决方案 、不提供归档存储、但您可以将旧备份文件移动到公共云归档存储。以这种方式使用时、分层到云存储或从云存储还原的数据将在StorageGRID 和云存储之间传输-此数据传输不涉及BlueXP。

通过当前支持、您可以将备份归档到AWS _S3 Glacier //_S3 Glacier Deep Archive_或_Azure Archive_存储。

* ONTAP 要求*

* 您的集群必须使用ONTAP 9.12.1或更高版本


* StorageGRID 要求*

* 您的StorageGRID 必须使用11.4或更高版本
* 您的StorageGRID 必须是 https://docs.netapp.com/us-en/cloud-manager-storagegrid/task-discover-storagegrid.html["已在BlueXP画布中发现并提供"^]。


* Amazon S3要求*

* 您需要为归档备份所在的存储空间注册Amazon S3帐户。
* 您可以选择将备份分层到AWS S3 Glacier或S3 Glacier深度归档存储。 link:reference-aws-backup-tiers.html["了解有关AWS归档层的更多信息"^]。
* StorageGRID 应对存储分段具有完全控制访问权限 (`s3:*`)；但是、如果无法执行此操作、则存储分段策略必须向StorageGRID 授予以下S3权限：
+
** `s3:AbortMultipartUpload`
** `s3:DeleteObject`
** `s3:GetObject`
** `s3:ListBucket`
** `s3:ListBucketMultipartUploads`
** `s3:ListMultipartUploadParts`
** `s3:PutObject`
** `s3:RestoreObject`




* Azure Blob要求*

* 您需要为归档备份所在的存储空间注册Azure订阅。
* 通过激活向导、您可以使用现有资源组来管理用于存储备份的Blob容器、也可以创建新的资源组。


在为集群的备份策略定义归档设置时、您将输入云提供商凭据并选择要使用的存储类。当您为集群激活备份时、BlueXP备份和恢复功能会创建云分段。AWS和Azure归档存储所需的信息如下所示。

image:screenshot_sg_archive_to_cloud.png["将备份文件从StorageGRID 归档到AWS S3或Azure Blob所需信息的屏幕截图。"]

您选择的归档策略设置将在StorageGRID 中生成信息生命周期管理(ILM)策略、并将这些设置添加为"规则"。如果存在活动的ILM策略、则新规则将添加到ILM策略中、以将数据移动到归档层。如果现有ILM策略处于"建议"状态、则无法创建和激活新的ILM策略。 https://docs.netapp.com/us-en/storagegrid-116/ilm/index.html["详细了解StorageGRID ILM策略和规则"^]。



=== 许可证要求

在为集群激活BlueXP备份和恢复之前、您需要从NetApp购买并激活BlueXP备份和恢复BYOL许可证。此许可证适用于帐户，可在多个系统中使用。

您需要 NetApp 提供的序列号，以便在许可证有效期和容量内使用此服务。 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["了解如何管理 BYOL 许可证"]。


TIP: 将文件备份到 StorageGRID 时不支持 PAYGO 许可。



== 启用到StorageGRID 的BlueXP备份和恢复

随时直接从内部工作环境启用BlueXP备份和恢复。

.步骤
. 在Canvas中、选择内部工作环境、然后单击右侧面板中备份和恢复服务旁边的*启用>备份卷*。
+
如果用于备份的StorageGRID 目标作为工作环境存在于Canvas上、则可以将集群拖动到StorageGRID 工作环境中以启动设置向导。

+
image:screenshot_backup_onprem_enable.png["屏幕截图显示了\"启用备份和恢复\"按钮、该按钮可在您选择工作环境后使用。"]

. 选择 * StorageGRID 提供程序 * ，单击 * 下一步 * ，然后输入提供程序详细信息：
+
.. StorageGRID 网关节点的FQDN。
.. ONTAP 与StorageGRID 进行HTTPS通信时应使用的端口。
.. 用于访问存储备份的存储分段的访问密钥和机密密钥。
.. 要备份的卷所在的 ONTAP 集群中的 IP 空间。此 IP 空间的集群间 LIF 必须具有出站 Internet 访问权限（在 " 非公开 " 站点中安装 Connector 时不需要）。
+
选择正确的IP空间可确保BlueXP备份和恢复可以设置从ONTAP 到StorageGRID 对象存储的连接。

+
image:screenshot_backup_provider_settings_storagegrid.png["显示将卷从内部集群备份到 StorageGRID 存储时云提供商详细信息的屏幕截图。"]



. 输入要用于默认策略的备份策略详细信息、然后单击*下一步*。您可以选择现有策略、也可以通过在每个部分中输入所做的选择来创建新策略：
+
.. 输入默认策略的名称。您无需更改名称。
.. 定义备份计划并选择要保留的备份数。 link:concept-ontap-backup-to-cloud.html#customizable-backup-schedule-and-retention-settings["请参见您可以选择的现有策略列表"^]。
.. 如果您的集群使用的是ONTAP 9.11.1或更高版本、则可以选择通过配置_DataLock和勒索软件保护_来保护您的备份免受删除和勒索软件攻击。_DataLock_可防止您的备份文件被修改或删除、_勒索 软件保护_会扫描您的备份文件、以在备份文件中查找勒索软件攻击的证据。 link:concept-cloud-backup-policies.html#datalock-and-ransomware-protection["详细了解可用的DataLock设置"^]。
.. 如果集群使用的是ONTAP 9.12.1或更高版本、而StorageGRID 系统使用的是版本11.4或更高版本、则可以选择在一定天数后将较早的备份分层到公共云归档层。目前支持AWS S3 Glacer/S3 Glacier深度归档或Azure归档存储层。 <<准备将旧备份文件归档到公共云存储,了解如何为此功能配置系统>>。
+
image:screenshot_backup_onprem_policy.png["屏幕截图显示了BlueXP备份和恢复设置、您可以在其中选择备份计划和保留期限。"]

+
*重要信息：*如果您计划使用DataLock、则必须在激活BlueXP备份和恢复时在第一个策略中启用它。



. 在选择卷页面中、使用定义的备份策略选择要备份的卷。如果要为某些卷分配不同的备份策略，可以创建其他策略并稍后将其应用于这些卷。
+
** 要备份所有现有卷以及将来添加的任何卷、请选中"备份所有现有卷和未来卷..."框。我们建议使用此选项、以便备份所有卷、您不必记住为新卷启用备份。
** 要仅备份现有卷、请选中标题行(image:button_backup_all_volumes.png[""]）。
** 要备份单个卷，请选中每个卷对应的框（image:button_backup_1_volume.png[""]）。
+
image:screenshot_backup_select_volumes.png["选择要备份的卷的屏幕截图。"]

** 如果此工作环境中的读/写卷有任何本地Snapshot副本与您刚刚为此工作环境选择的备份计划标签(例如、每日、每周等)匹配、则会显示一条额外的提示"将现有Snapshot副本作为备份副本导出到对象存储"。如果要将所有历史快照作为备份文件复制到对象存储、请选中此框、以确保为卷提供最全面的保护。


. 单击*激活备份*、BlueXP备份和恢复将开始对每个选定卷进行初始备份。


.结果
系统会在您输入的 S3 访问密钥和机密密钥所指示的服务帐户中自动创建 S3 存储分段，备份文件存储在该处。此时将显示卷备份信息板，以便您可以监控备份的状态。您还可以使用监控备份和还原作业的状态 link:task-monitor-backup-jobs.html["作业监控面板"^]。



== 下一步是什么？

* 您可以 link:task-manage-backups-ontap.html["管理备份文件和备份策略"^]。其中包括启动和停止备份、删除备份、添加和更改备份计划等。
* 您可以 link:task-manage-backup-settings-ontap.html["管理集群级别的备份设置"^]。其中包括更改ONTAP 用于访问云存储的存储密钥、更改可用于将备份上传到对象存储的网络带宽、更改未来卷的自动备份设置等。
* 您也可以 link:task-restore-backups-ontap.html["从备份文件还原卷、文件夹或单个文件"^] 内部部署的ONTAP 系统。

